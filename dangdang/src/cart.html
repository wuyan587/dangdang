<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>购物车-当当网</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/public.css">
    <link rel="stylesheet" href="./css/cart.css">
</head>
<body>
    <header>
        <div id="top" style="width: 960px;margin: 0 auto;">

            <ul class="right">
                <li><a href="http://10.31.155.71/dangdang/dangdang/src/cart.html">购物车<span>0</span></a></li>
                <li><a href="">我的订单</a> </li>
                <li><a href="">我的云书房</a> </li>
                <li><a href="">我的当当</a></li>
                <li><a href="">0元领物</a></li>
                <li><a href="">小说投稿</a></li>
                <li><a href="">我要出书</a></li>
                <li><a href="">企业采购</a></li>
                <li><a href="">客户服务</a></li>
            </ul>
            <div class="middle" style="float:left">
                <p>欢迎光临当当，请
                    <a href="http://10.31.155.71/dangdang/dangdang/src/login.html">登陆</a>
                    <a href="http://10.31.155.71/dangdang/dangdang/src/register.html">成为会员</a>
                </p>
            </div>
        </div>
    </header>
    <div class="cart_warp">
        <a href=""><img src="http://img61.ddimg.cn/2019/9/27/2019092717114210788.jpg"></a>
    </div>
    <div class="logo_line">
        <div class="warp">
            <div class="procedur">
                <span class="active">我的购物车</span>
                <span>填写订单</span>
                <span>完成订单</span>
            </div>
            <div class="logo">
                <a href=""><img src="./img/dd_logo.jpg" alt=""></a></div>
        </div>

    </div>
    <div class="add">
        <div class="warp">
            <div class="address">
                <span></span>配送地址：
                <div class="select_add">
                    <span class="choose">北京</span>
                    <div class="add_list"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="warp">
            <ul class="shop_title">
                <li class="f1"><a id="j_selectall" href="javascript:void(0)"
                        class="checknow fn-checkall check_on checkon" dd_name="全选">选中</a>全选</li>
                <li class="f2">商品信息</li>
                <li class="f3">单价（元）</li>
                <li class="f4">数量</li>
                <li class="f4">金额（元）</li>
                <li class="f5">操作</li>
            </ul>
            <div class="shop_content">
                <table border="0" cellspacing="0" cellpadding="0" class="shop_Ttitle">
                    <tbody>
                        <tr>
                            <td><a href="javascript:;" class="checknow fn-shop-checkall check_on ">选中</a></td>
                            <td><span class="shop_icon"></span></td>
                            <td><a href="javascript:;" target="_blank" style="font-size:12px;">当当自营</a></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                <div class="shop_list">
                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                    </table>
                </div>
            </div>

        </div>
        <div class="clearshop">
            <div class="clearshop_right">
                <a href="" class="total_btn">结算</a>
                <div class="money">
                    <p>
                        <span>总计(不含运费)：</span>
                        <span class='price'>0</span>
                    </p>
                    <p>
                        <span>已节省：</span>
                        <span>0.00</span>
                    </p>
                </div>
            </div>
            <div class="clearshop_left">
                <a href="javascript:;" class="checknow fn-checkall checkon">选中</a>全选
                <a href="javascript:;" class="delete">批量删除</a>
                <span>已选择
                    <i color="red">0</i>
                    件商品</span>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script>
        let num = 0, price = 0 , z = 0;;
        if ($.cookie('sid') && $.cookie('num')) {
            let htmlstr = '', linkurl = 'http://10.31.155.71/dangdang/dangdang/src/detail.html?';
            for (let i of $.cookie('sid').split(',')) {
                $.ajax(
                    {
                        type: 'get',
                        url: "http://10.31.155.71/dangdang/dangdang/php/goodslist.php",
                        data: {
                            sid: i
                        },
                        dataType: 'json'
                    }
                ).done(function (data) {
                    htmlstr += `  <tbody>
                            <tr id="" sid='${data.sid}' class="bb_none tree_first ">
                                <td class="row1">
                                    <a href="javascript:;" class="checknow checkon pcheck">选中</a>
                                </td>
                                <td class="row_img">
                                    <a href="${linkurl + 'sid=' + data.sid}" target="_blank">
                                        <img src="${data.url}" width="80"
                                            height="80">
                                    </a>
                                    <div style="display: none;" class="img_big">
                                        <a href="${linkurl + 'sid=' + data.sid}" target="_blank">
                                            <img src="${data.url}">
                                        </a>
                                        <span class="arrow">
                                        </span>
                                    </div>
                                </td>
                                <td class="row_name">
                                    <div class="name">
                                        <a href="${linkurl + 'sid=' + data.sid}" title="平行宇宙（新版）"
                                            target="_blank"
                                            style="word-break:break-all;  word-wrap:break-word;">${data.title}</a></div>
                                </td>
                                <td class="row3">
                                    <span>${data.nprice}</span></td>
                                <td class="fn-count-tip row3 ">
                                    <span class="amount ">
                                        <a href="javascript:;" class='del'>-</a><input value="${$.cookie('num').split(',')[$.cookie('sid').split(',').indexOf(i)]}" type="text">
                                        <a href="javascript:;" class='add'>+</a></span></td>
                                <td class="row4">
                                    <span class="red">￥${(data.nprice * 100) * ($.cookie('num').split(',')[$.cookie('sid').split(',').indexOf(i)] / 100)}</span>
                                </td>
                                <td class="row5 ">
                                    <span>
                                        <a href="javascript:;" class="fn-add-wish">移入收藏</a>
                                    </span>
                                    <span>
                                        <a href="javascript:;" class="fn-remove-product">删除</a>
                                    </span>
                                </td>
                            </tr>
                            <tr class="tree_last">
                                <td class="row1"></td>
                                <td class="row_img">
                                    <span class="tree_icon">&nbsp;</span>
                                </td>
                                <td class="event_box" colspan="5">
                                    <p class="event">购买此商品,可享促销&nbsp;&nbsp;<a href="javascript:;"
                                            class="ebtn eblue fn-toggle-exchange-gift" itemid="776828382">加价购</a></p>
                                    <div class="event_list" style="display:none">
                                        <div class="pages fn-pages"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>`
                    $('.shop_list table').html(htmlstr);
                    jiage();
                    numb();
                    $('input').on('blur', function () {
                        num = $(this).parent().find('input').val();
                        zonjia($(this), num);
                        jiage();
                        setcookie($(this));
         })
                })
            }


        }
        $('.content').on('click', function (ev) {
            let chosebtn = $('.checknow').not('.fn-checkall').not('.fn-shop-checkall');
            let chosebtnon = $('.checkon').not('.fn-checkall').not('.fn-shop-checkall');
            let e = ev.target;
            // if($(e).hasClass('fn-checkall')){
            //     if ($(e).hasClass('checkon')) {
            //                             // console.log(1);
            //                             $('.fn-checkall').removeClass('checkon');
            //                             chosebtn.removeClass('checkon');
            //                         } else {
            //                             // console.log(2);
            //                             $('.fn-checkall').addClass('checkon');
            //                             chosebtn.addClass('checkon');
            //                         }
            //                         numb();
            //                         jiage();
            // }
            switch (true) {
                case $(e).hasClass('add'):
                    num = $(e).parent().find('input').val();
                    // console.log($(e).parentsUntil('tbody').find('.row4 span'));
                    num++;
                    zonjia($(e), num)
                    setcookie($(e));
                    jiage();
                    break;
                case $(e).hasClass('del'):
                    num = $(e).parent().find('input').val();
                    num--;
                    if (num < 0)
                        num = 0;
                    zonjia($(e), num)
                    setcookie($(e));
                    break;
                case $(e).hasClass('fn-checkall'):
                    if ($(e).hasClass('checkon')) {
                        // console.log(1);
                        $('.fn-checkall').removeClass('checkon');
                        chosebtn.removeClass('checkon');
                    } else {
                        // console.log(2);
                        $('.fn-checkall').addClass('checkon');
                        chosebtn.addClass('checkon');
                    }
                    numb();
                    jiage();
                    break;
                case $(e).hasClass('pcheck'):
                    if ($(e).hasClass('checkon')) {
                            $(e).removeClass('checkon')
                        } else {
                            $(e).addClass('checkon');
                        }
                        if (chosebtn.filter('.checkon').length == chosebtn.length) {
                            $('.fn-checkall').addClass('checkon');
                        } else {
                            $('.fn-checkall').removeClass('checkon');
                        }
                        numb();
                        jiage();
                        break;
                case $(e).hasClass('fn-remove-product'):
                        delcookie($(e));
                                $(e).parentsUntil('tbody').parent().remove();
                                jiage()
                                numb();
                        break;
                case $(e).hasClass('delete'):
                
                chosebtnon.each(function () {
                            delcookie($(this));
                            $(this).parentsUntil('tbody').parent().remove();
                        })
                        numb();
                        jiage();
                        break;
            }
        })
       


        function jiage() {
            z = 0;
            $('.shop_list').find('.checkon').parentsUntil('tbody').find('.row4 span').each(function () {
                z += +($(this).html().substring(1) * 100);
            })
            $('.money p:first span:last').html(z / 100);
        }
        function zonjia(obj, num) {
            price = num * (obj.parentsUntil('tbody').find('.row3 span').html() * 100);
            obj.parent().find('input').val(num);
            obj.parentsUntil('tbody').find('.row4 span').html('￥' + price / 100);
            jiage();
        }
        function setcookie(obj) {
            let n = obj.parentsUntil('tbody').find('input').val();
            let a = obj.parentsUntil('tbody').parent().find('tr').attr('sid');
            let b = $.cookie('sid').split(',');
            let c = $.cookie('num').split(',');
            c[b.indexOf(a)] = n;
            $.cookie('sid', b);
            $.cookie('num', c);
        }
        function delcookie(obj) {
            let a = obj.parentsUntil('tbody').parent().find('tr').attr('sid');
            let b = $.cookie('sid').split(',');
            let c = $.cookie('num').split(',');
            b.splice(b.indexOf(a), 1);
            c.splice(b.indexOf(a), 1);
            $.cookie('sid', b);
            $.cookie('num', c);
        }
        function numb() {
            $('.clearshop_left span i').html($('.shop_list').find('.checkon').length);
        }
    </script>
</body>

</html>